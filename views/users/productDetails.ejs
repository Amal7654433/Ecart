<%- include("../partials/userHead2.ejs")%>
    <style>
        .icon-hover:hover {
            border-color: #3b71ca !important;
            background-color: white !important;
            color: #3b71ca !important;
        }

        .icon-hover:hover i {
            color: #3b71ca !important;
        }

        #foot {
            margin-top: 10rem;

        }
    </style>
    <style>
        #img-zoomer-box {
            max-width: 500px;
            height: auto;
            position: relative;
            margin: 10px auto;
        }

        #mainImage {
            width: 100%;
            height: auto;
        }

        #img-zoomer-box:hover,
        #img-zoomer-box:active {
            cursor: zoom-in;
            display: block;
        }

        #img-zoomer-box:hover #img-2,
        #img-zoomer-box:active #img-2 {
            opacity: 1;
        }

        #img-2 {
            width: 340px;
            height: 340px;
            background: url('/images/<%= product.image[0] %>') no-repeat #FFF;
            box-shadow: 0 5px 10px -2px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            position: absolute;
            opacity: 0;
            border: 4px solid whitesmoke;
            z-index: 99;
            border-radius: 100%;
            display: block;
            transition: opacity .2s;
        }
    </style>

    <!-- <style>


#mainImage {
  max-width: 100%;
}
#overlay {
  display: none;
  background: url('/images/<%= product.image[0] %>') ;
  position: absolute;
  width: 25%;
  height: 35%;
  margin-top: -30%;
  margin-left: 50%;
  border: 2px solid #555;
  z-index: 1000;
  background-repeat: no-repeat;
}
#mouse-overlay {
  cursor: zoom-in;
  position: absolute;
  width: 2em;
  height: 2em;
  transform: translate(-50%, -50%);
  background-color: rgba(245, 245, 245, 0.6);
  border-radius: 50%;
}
@media only screen and (max-width: 768px) {
  #image-container {
    width: 55%;
  }
  #overlay {
    margin-left: 70%;
    width: 25%;
    height: 15%;
  }
}
</style> -->


    <!-- content -->
    <section class="py-5">
        
        <div class="container">
            <div class="row gx-5">
                <aside class="col-lg-6">
                    
                    <div id="img-zoomer-box" class="border rounded-4 mb-3 d-flex justify-content-baseline">
                        
                        <img id="mainImage" style="max-width: 100%; max-height: 100vh; margin: auto;"
                            class="rounded-4 fit" src="/images/<%= product.image[0] %>" />
                        <div id="img-2"></div>

                    </div>
                    <!-- <div id="mouse-overlay"></div>
                    <div id="overlay"></div> -->
                    <div id="image-container" class="d-flex justify-content-center mb-3">
                        <a data-fslightbox="mygalley" class="border mx-1 rounded-2" target="_blank" data-type="image"
                            class="item-thumb">
                            <% product.image.forEach(function(image, i) { %>
                                <img width="60" height="60" class=" rounded-2" src="/images/<%= image %>"
                                    onclick="changeMainImage('<%= image %>')" />
                                <% }); %>
                        </a>
                    </div>
                </aside>

                <script>
                    function changeMainImage(newImage) {
                        // Get the main image element by its ID
                        var mainImage = document.getElementById("mainImage");
                        // Set the src attribute of the main image to the clicked thumbnail's image URL
                        mainImage.src = "/images/" + newImage;
                    }
                </script>

                <main class="col-lg-6">
                    <a href="#"   onclick="addToWishlist('<%= product._id %>')"
                        class=" py-2 icon-hover  float-end"> <i
                            class="me-1 fa fa-heart fa-lg " style="color: red;"></i>  </a>
                    <div class="ps-lg-3">
                        <h4 class="title text-dark">
                            <%=product.name%>
                        </h4>
                        
                        <div class="d-flex flex-row my-3">
                            <div class="text-warning mb-1 me-2">
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fa fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span class="ms-1">
                                    4.5
                                </span>
                            </div>
                            <span class="text-muted"><i class="fas fa-shopping-basket fa-sm mx-1"></i>
                                <%=product.stock%>
                            </span>
                            <span class="text-success ms-2">In stock</span>
                        </div>

                        <div class="mb-3">
                            <p class="h5"> â‚¹<%=product.price%>
                            </p>
                            <!-- <span class="text-muted">/per box</span> -->
                            <span>
                                <% if (product.discount !==0) { %>
                                    <%= product.discount %>% off
                                        <% } %>
                            </span>
                        </div>


                        <p>
                            <%=product.details%>
                        </p>

                        <div class="row">


                            <dt class="col-3">Brand</dt>
                            <dd class="col-9">
                                <%=product.brand%>
                            </dd>
                        </div>

                        <hr />

                        <div class="row mb-4">
                            <!-- <div class="col-md-4 col-6">
                                <label class="mb-2">Size</label>
                                <select class="form-select border border-secondary" style="height: 35px;">
                                    <option>Small</option>
                                    <option>Medium</option>
                                    <option>Large</option>
                                </select>
                            </div> -->
                            <!-- col.// -->
                            <!-- <div class="col-md-4 col-6 mb-3">
                                <label class="mb-2 d-block">Quantity</label>
                                <div class="input-group mb-3" style="width: 170px;">
                                    <button class="btn btn-white border border-secondary px-3" type="button"
                                        id="button-addon1" data-mdb-ripple-color="dark">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="text" class="form-control text-center border border-secondary"
                                        placeholder="14" aria-label="Example text with button addon"
                                        aria-describedby="button-addon1" />
                                    <button class="btn btn-white border border-secondary px-3" type="button"
                                        id="button-addon2" data-mdb-ripple-color="dark">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div> -->

                        </div>
                        <% if (product.stock < 1) { %>
                            <span aria-disabled="true">out of stock</span>
                            <% } else { %>
                                <a href="/checkout?buynow=true"  onclick="buynow(`<%= product._id %>`)" class="text-white btn btn-warning  " style="width: 200px; height: 50px;" >
                                       <h5 class="mt-1"> Buy Now</h5> </a>
                                <% if (product.inCart) { %>
                                    <a href="/cart" class="btn btn-primary text-center " style="height: 50px; width: 200px;"><h5 class="mt-1">Go To Cart</h5></a>
                                    <% } else { %>
                                        <!-- <button class="add-to-cart-btn" productId="<%= product._id %>">Add to Cart</button> -->
                                        <button class="btn btn-primary text-center" style="height: 50px; width: 200px;" onclick="addCart(`<%= product._id %>`)"> 
                                            <h5 class="mt-1">Add To Cart</h5></button>

                                        <% } %>
                                            
                                            <% } %>
                    </div>
                </main>
            </div>
        </div>
    </section>
    <%- include("../partials/userFooter.ejs")%>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>

        let zoomer = function () {
            document.querySelector('#img-zoomer-box')
                .addEventListener('mousemove', function (e) {

                    let original = document.querySelector('#mainImage'),
                        magnified = document.querySelector('#img-2'),
                        style = magnified.style,
                        x = e.pageX - this.offsetLeft,
                        y = e.pageY - this.offsetTop,
                        imgWidth = original.offsetWidth,
                        imgHeight = original.offsetHeight,
                        xperc = ((x / imgWidth) * 100),
                        yperc = ((y / imgHeight) * 100);


                    if (x > (.01 * imgWidth)) {
                        xperc += (.15 * xperc);
                    };

                    //lets user scroll past bottom edge of image
                    if (y >= (.01 * imgHeight)) {
                        yperc += (.15 * yperc);
                    };

                    style.backgroundPositionX = (xperc - 9) + '%';
                    style.backgroundPositionY = (yperc - 9) + '%';

                    style.left = (x - 180) + 'px';
                    style.top = (y - 180) + 'px';

                }, false);
        }();
    </script>


    <!-- <script>
    const imageContainer = document.getElementById("image-container");
    const overlay = document.getElementById("overlay");
    const mouseOverlay = document.getElementById("mouse-overlay");
    
    const events = {
      mouse: "mousemove",
      touch: "touchmove",
    };

    const isTouchDevice = () => {
      try {
        document.createEvent("TouchEvent");
        return "touch";
      } catch (e) {
        return "mouse";
      }
    };
    
   
    let deviceType = isTouchDevice();
    
 
    const hideElements = () => {
      overlay.style.display = "none";
      mouseOverlay.style.display = "none";
    };
    
   
    imageContainer.addEventListener(events[deviceType], (e) => {
      try {
        const { pageX, pageY, touches } = e;
        const touch = touches ? touches[0] : e;
        const x = touch.pageX;
        const y = touch.pageY;
    
        const imageWidth = imageContainer.offsetWidth;
        const imageHeight = imageContainer.offsetHeight;
    
        const isOutsideContainer =
          x - imageContainer.offsetLeft < 15 ||
          imageWidth - (x - imageContainer.offsetLeft) < 15 ||
          y - imageContainer.offsetTop < 15 ||
          imageHeight - (y - imageContainer.offsetTop) < 15;
    
        if (isOutsideContainer) {
          hideElements();
        } else {
          overlay.style.display = "block";
          mouseOverlay.style.display = "inline-block";
        }
    
        const posX = ((x - imageContainer.offsetLeft) / imageWidth) * 100;
        const posY = ((y - imageContainer.offsetTop) / imageHeight) * 100;
    
        overlay.style.backgroundPosition = `${posX}% ${posY}%`;
        mouseOverlay.style.top = `${y}px`;
        mouseOverlay.style.left = `${x}px`;
      } catch (error) {
        console.error("Error handling event:", error);
      }
    });
    </script> -->
    <script>
        $(document).ready(function () {
            $('.decrease-quantity-btn, .increase-quantity-btn').on('click', function () {
                const productId = $(this).data('product-id');
                const action = $(this).data('action');
                const quantityInput = $('#quantity_' + productId);
                let newQuantity = parseInt(quantityInput.val());

                if (action === 'decrease' && newQuantity > 1) {
                    newQuantity--;
                } else if (action === 'increase') {
                    newQuantity++;
                }


                quantityInput.val(newQuantity);


                $.ajax({
                    url: '/cart/update-quantity',
                    method: 'PATCH',
                    data: { productId, newQuantity },
                    success: function (data) {

                    },
                    error: function (error) {
                        console.error('Error updating quantity:', error);

                    }
                });
            });
        });
    </script>

    <script>function buynow(id) {

            fetch(`/addtocart/${id}`, {
                method: 'PATCH',
            }).then(() => {
                window.location.assign(`/checkout?id=${id}`);
            }).catch((error) => {
                console.error('Error deleting product:', error);
                // Optionally handle error and show error message to the user
            });
        }</script>
    <script>function addCart(id) {

            fetch(`/addtocart/${id}`, {
                method: 'PATCH',
            }).then(() => {
                window.location.assign('/cart')
            }).catch((error) => {
                console.error('Error deleting product:', error);
                // Optionally handle error and show error message to the user
            });
        }</script>
    <script src="https://unpkg.com/js-image-zoom@0.4.1/js-image-zoom.js" type="application/javascript"></script>
    <script>
        var options = {
            width: 400,
            height: 250,
            zoomWidth: 500,
            offset: { vertical: 0, horizontal: 10 },
            scale: 1.5


        }
        new ImageZoom(document.getElementById('mainImage'), options)
    </script>
    <script>
        function addToWishlist(id) {
          console.log('amal');
          fetch(`/add-wishlist/${id}`, {
            method: 'PATCH',
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error('Failed to add product to wishlist');
              }
            })
            .then((data) => {
              if (data.exist) {
                Swal.fire({
                  title: 'Product Already in Wishlist',
                  icon: 'info',
                });
              } else if (data.success) {
                Swal.fire({
                  title: 'Product Added to Wishlist',
                  icon: 'success',
                }).then(() => {
                  window.location.assign('/wishlist');
                });
              }
            })
            .catch((error) => {
              console.error('Error adding product to wishlist:', error);
              // Handle other errors or show a general error message
              swal('Error', 'Failed to add product to wishlist', 'error');
            });
        }
      </script>
   
       